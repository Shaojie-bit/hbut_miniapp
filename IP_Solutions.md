# 关于教务系统反爬虫（IP封禁）的解决方案

由于微信小程序必须配置合法的业务域名（且无法配置教务系统域名），所有的请求确实需要经过后端服务器中转。当用户量增大时，单一服务器IP高频访问教务系统极易触发防火墙或WAF拦截。

以下是几种主流的解决方案，按推荐程度排序：

## 1. 使用代理IP池 (推荐)
这是最标准、成本可控且改动最小的方案。

**原理**：后端服务器在向教务系统发起请求时，不直接使用本机IP，而是通过代理服务器（Proxy）转发。每次请求或每个用户的Session绑定不同的代理IP。

**实施步骤**：
1.  **购买代理服务**：选择提供“隧道代理”或“动态短效代理”的服务商（如阿布云、快代理、芝麻代理等）。
2.  **修改代码**：
    在 `backend/cjcx+pm.py` 中，为 `requests.Session()` 添加代理配置。
    ```python
    # 示例代码
    proxies = {
        "http": "http://user:pass@proxy_host:port",
        "https": "http://user:pass@proxy_host:port"
    }
    session.proxies.update(proxies)
    ```
3.  **策略**：
    *   **按请求轮询**：每次API调用都换一个IP（适合无状态接口）。
    *   **按Session绑定**：由于教务系统有Cookie/Session状态，建议在用户登录期间（Login -> Get Data）保持使用同一个代理IP，直到Session失效。

**优点**：代码改动小，可以复用现有架构。
**缺点**：需要持续付费购买代理IP。

## 2. 腾讯云/阿里云 Serverless 云函数 (强烈推荐)

**原理**：将你的爬虫/代理逻辑部署在云函数（SCF/FC）上。云函数每次运行的容器可能不同，且出口IP是云厂商巨大的共享IP池，天然具有极高的IP轮转率，极难被封禁。

**实施步骤**：
1.  将 `cjcx+pm.py` 改造为适合云函数的入口格式（例如配合API网关触发）。
2.  前端小程序既可以请求你的原服务器（原服务器再调用云函数），也可以直接请求云函数的API网关（需要配置域名）。

**优点**：
*   **天然防封**：拥有海量IP池。
*   **弹性扩容**：高并发时自动扩容，不用担心服务器崩掉。
*   **按量付费**：请求少时几乎免费。
**缺点**：Session管理稍微麻烦一点（需要用Redis外部存储Cookie，因为云函数是无状态的）。

## 3. 微信云托管 (WeChat CloudRun) / 微信云开发

**原理**：这是微信官方提供的Serverless容器服务，内网拥有大量出口IP。

**优点**：与微信小程序生态通过“微信私有链路”通信，免鉴权，速度快，天然IP池。
**缺点**：需要容器化部署（Docker），成本略高于普通云函数。

## 4. 优化请求策略 (辅助手段)

无论使用哪种架构，都应配合以下策略减少负载：

*   **缓存 (Caching)**：
    *   **课表**：一学期基本不变，没必要每次打开都查。缓存 24小时 或 1周。
    *   **成绩**：只有考试周变动频繁。平时缓存 1小时甚至更久。
    *   **排名**：基本只在期末出，缓存极长时间。
    *   **实现**：在你的 `FAKE_REDIS` 或真实Redis中存储数据，用户请求时先查缓存。
*   **错峰请求**：不要在所有用户打开小程序的一瞬间（比如早上8点）并发轰炸教务系统，可以排队或预加载。

## 总结建议

1.  **短期/快速方案**：购买**隧道代理**，修改后端 `requests` 代码挂代理。
2.  **长期/低成本方案**：迁移到 **Serverless 云函数** 或 **微信云托管**，利用云厂商的IP池，并加入**Redis缓存**层减少回源请求。

鉴于你当前已经有 FastAPI 后端，最平滑的升级路径是 **方案 1 (加代理)** 或 **方案 2 (部分接口迁移至云函数)**。
