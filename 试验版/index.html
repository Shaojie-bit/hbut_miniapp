<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBUT æ•™åŠ¡ (æœ€ç»ˆç‰ˆ)</title>
    <style>
        /* å¸ƒå±€å˜é‡ï¼šè¡Œé«˜ 58px é€‚åˆæ˜¾ç¤ºè¾ƒå¤šå†…å®¹ */
        :root { --primary: #007bff; --bg: #f4f7f6; --header-h: 40px; --row-h: 58px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary); }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.3s; }
        .form-group { margin-bottom: 15px; }
        input, button, select { width: 100%; padding: 10px; margin-top:5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--primary); color: #fff; border: none; cursor: pointer; font-size: 16px; margin-top: 15px;}
        button:disabled { background: #ccc; }
        
        #captcha-area { display: none; background: #fff3f3; padding: 10px; margin-top: 10px; border: 1px dashed #f8d7da; border-radius: 4px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: #eee; border: none; color: #666; cursor: pointer; border-radius: 5px; text-align: center; }
        .tab-btn.active { background: var(--primary); color: #fff; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #eee; padding: 8px; font-size: 13px; }
        .pass { color: green; } .fail { color: red; }

        /* ================= è¯¾è¡¨æ–°æ ·å¼ (ç»å¯¹å®šä½) ================= */
        .timetable-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: #eef; padding: 10px; border-radius: 5px;}
        
        .kb-container {
            position: relative;
            width: 100%;
            border: 1px solid #e0e0e0;
            background: #fff;
            display: flex;
            flex-direction: column;
            min-height: 800px; /* ä¿è¯é«˜åº¦è¶³å¤Ÿ */
        }

        .kb-header { display: flex; height: var(--header-h); background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
        .kb-header-item { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #555; border-right: 1px solid #f0f0f0; }
        .kb-header-left { width: 40px; background: #f0f0f0; border-right: 1px solid #ddd; }

        .kb-body {
            position: relative;
            display: flex;
            /* 12èŠ‚ * 58px */
            height: calc(var(--row-h) * 12); 
            overflow-y: auto;
            overflow-x: hidden;
        }

        .kb-sidebar { width: 40px; background: #fafafa; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .kb-sidebar-item { height: var(--row-h); display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; border-bottom: 1px dashed #eee; }

        .kb-content {
            flex: 1;
            position: relative;
            background-image: linear-gradient(#f9f9f9 1px, transparent 0);
            background-size: 100% var(--row-h); /* ç”»æ¨ªçº¿è¾…åŠ©å¯¹é½ */
        }

        /* è¯¾ç¨‹å¡ç‰‡ */
        .course-card-abs {
            position: absolute;
            width: calc(100% / 7 - 2px); /* ç•™ç‚¹ç¼éš™ */
            border-radius: 4px;
            padding: 2px;
            box-sizing: border-box;
            font-size: 11px;
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 10;
            line-height: 1.25;
            transition: transform 0.2s, z-index 0.2s;
        }
        .course-card-abs:hover { transform: scale(1.05); z-index: 50; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .course-name { font-weight: bold; margin-bottom: 2px; }
        .course-info { font-size: 10px; opacity: 0.95; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ HBUT æ•™åŠ¡ (æ™ºèƒ½ OCR ç™»å½•)</h2>

    <!-- ç™»å½•é¢æ¿ -->
    <div id="panel-login" class="panel active">
        <h3>ç»Ÿä¸€èº«ä»½è®¤è¯</h3>
        <div class="form-group">
            <input type="text" id="u_name" placeholder="å­¦å·">
            <input type="password" id="u_pass" placeholder="å¯†ç ">
            <div id="captcha-area">
                <p style="color:red; font-size:12px; margin:0 0 5px 0;">âš ï¸ è‡ªåŠ¨è¯†åˆ«å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ï¼š</p>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="u_captcha" placeholder="éªŒè¯ç ">
                    <img id="captcha-img" src="" onclick="refreshCaptcha()" style="height:42px; border:1px solid #ddd; cursor:pointer;" title="çœ‹ä¸æ¸…ï¼Ÿæ¢ä¸€å¼ ">
                </div>
            </div>
        </div>
        <button onclick="doLogin()" id="btn-login">å®‰å…¨ç™»å½•</button>
        <p id="login-msg" style="color:blue; margin-top:10px; font-size:13px;"></p>
    </div>

    <!-- ä¸»é¢æ¿ -->
    <div id="panel-main" class="panel">
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('grade')">ğŸ“Š æˆç»©æŸ¥è¯¢</div>
            <div class="tab-btn" onclick="switchTab('timetable')">ğŸ“… è¯¾è¡¨æŸ¥è¯¢</div>
        </div>

        <!-- æˆç»©è§†å›¾ -->
        <div id="view-grade">
            <button onclick="fetchGrades()" style="width:auto; margin-bottom:10px;">åˆ·æ–°æˆç»©</button>
            <div style="overflow-x:auto;">
                <table id="grade-table">
                    <thead><tr><th>å­¦æœŸ</th><th>è¯¾ç¨‹å</th><th>æ€§è´¨</th><th>å­¦åˆ†</th><th>æˆç»©</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- è¯¾è¡¨è§†å›¾ -->
        <div id="view-timetable" style="display:none;">
            <div class="timetable-controls">
                <input type="text" id="kb-xnxq" value="2025-2026-1" style="width:120px;">
                <select id="week-select" onchange="renderCurrentWeek()"></select>
                <button onclick="fetchTimetableData()" style="width:auto; margin-top:0;">åˆ·æ–°</button>
            </div>
            
            <div class="kb-container">
                <div class="kb-header">
                    <div class="kb-header-left"></div>
                    <div class="kb-header-item">å‘¨ä¸€</div><div class="kb-header-item">å‘¨äºŒ</div><div class="kb-header-item">å‘¨ä¸‰</div>
                    <div class="kb-header-item">å‘¨å››</div><div class="kb-header-item">å‘¨äº”</div><div class="kb-header-item">å‘¨å…­</div><div class="kb-header-item">å‘¨æ—¥</div>
                </div>
                <div class="kb-body">
                    <div class="kb-sidebar">
                        <div class="kb-sidebar-item">1</div><div class="kb-sidebar-item">2</div><div class="kb-sidebar-item">3</div><div class="kb-sidebar-item">4</div>
                        <div class="kb-sidebar-item">5</div><div class="kb-sidebar-item">6</div><div class="kb-sidebar-item">7</div><div class="kb-sidebar-item">8</div>
                        <div class="kb-sidebar-item">9</div><div class="kb-sidebar-item">10</div><div class="kb-sidebar-item">11</div><div class="kb-sidebar-item">12</div>
                    </div>
                    <div class="kb-content" id="timetable-canvas"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "http://127.0.0.1:8000/api";
    let tempToken = null; let userToken = null; let allCourses = []; 
    const CARD_COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71'];
    
    function getCourseColor(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        return CARD_COLORS[Math.abs(hash) % CARD_COLORS.length];
    }

    async function doLogin() {
        const u = document.getElementById('u_name').value;
        const p = document.getElementById('u_pass').value;
        const c = document.getElementById('u_captcha').value;
        const btn = document.getElementById('btn-login');
        const msg = document.getElementById('login-msg');

        if(!u || !p) return alert("è¯·è¾“å…¥å­¦å·å’Œå¯†ç ");
        btn.disabled = true;
        msg.innerText = tempToken ? "æ­£åœ¨éªŒè¯..." : "æ­£åœ¨å°è¯•è‡ªåŠ¨ç™»å½•...";
        
        const payload = { username: u, password: p };
        if (tempToken) { payload.token = tempToken; payload.captcha = c; }

        try {
            const res = await fetch(`${API}/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const json = await res.json();
            if(json.code === 200) {
                userToken = json.user_token;
                document.getElementById('panel-login').classList.remove('active');
                document.getElementById('panel-main').classList.add('active');
                initWeekSelect();
                fetchGrades();
            } else if (json.code === 429) {
                msg.innerText = json.msg;
                document.getElementById('captcha-area').style.display = 'block';
                document.getElementById('captcha-img').src = json.data.image;
                tempToken = json.data.token;
            } else {
                msg.innerText = json.msg;
                if(tempToken) refreshCaptcha();
            }
        } catch (e) { msg.innerText = "Error: " + e.message; } 
        finally { btn.disabled = false; }
    }
    
    async function refreshCaptcha() { try { const res = await fetch(`${API}/captcha`); const json = await res.json(); document.getElementById('captcha-img').src = json.data.image; tempToken = json.data.token; } catch(e){} }
    function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); document.getElementById('view-grade').style.display = t==='grade'?'block':'none'; document.getElementById('view-timetable').style.display = t==='timetable'?'block':'none'; if(t==='timetable'&&allCourses.length===0) fetchTimetableData(); }
    async function fetchGrades() { 
        const tbody = document.querySelector('#grade-table tbody'); tbody.innerHTML='<tr><td colspan="5">åŠ è½½ä¸­...</td></tr>';
        const res = await fetch(`${API}/grades`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: userToken }) });
        const json = await res.json(); tbody.innerHTML='';
        if(json.code===200) json.data.forEach(item => { tbody.innerHTML+=`<tr><td>${item.semester}</td><td>${item.name}</td><td>${item.type}</td><td>${item.credit}</td><td class="${(parseFloat(item.score)>=60||item.score==='åˆæ ¼')?'pass':'fail'}">${item.score}</td></tr>`; });
    }
    function initWeekSelect() { const s=document.getElementById('week-select'); s.innerHTML=""; for(let i=1;i<=25;i++) s.innerHTML+=`<option value="${i}">ç¬¬ ${i} å‘¨</option>`; }
    async function fetchTimetableData() { 
        const xnxq = document.getElementById('kb-xnxq').value;
        const res = await fetch(`${API}/timetable`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: userToken, xnxq: xnxq }) });
        const json = await res.json();
        if(json.code===200) { allCourses = json.data; document.getElementById('week-select').value = json.current_week || 1; renderCurrentWeek(); }
    }

    // ================= æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ =================
    function renderCurrentWeek() {
        const week = parseInt(document.getElementById('week-select').value);
        const canvas = document.getElementById('timetable-canvas');
        canvas.innerHTML = ''; 

        // 1. ç­›é€‰æœ¬å‘¨è¯¾ç¨‹
        let courses = allCourses.filter(c => c.weeks_list.includes(week));

        // 2. æ’åºï¼ˆæŒ‰æ˜ŸæœŸã€èŠ‚æ¬¡ï¼‰
        courses.sort((a, b) => {
            if (a.day !== b.day) return a.day - b.day;
            return a.start - b.start;
        });

        // 3. åŠ¨æ€åˆå¹¶ï¼ˆä»…åˆå¹¶æœ¬å‘¨è§†è§‰ä¸Šè¿ç»­çš„ç›¸åŒè¯¾ç¨‹ï¼‰
        const mergedCourses = [];
        if (courses.length > 0) {
            let current = { ...courses[0] }; // å…‹éš†å¯¹è±¡ï¼Œé¿å…ä¿®æ”¹åŸæ•°æ®
            for (let i = 1; i < courses.length; i++) {
                const next = courses[i];
                const isSame = (
                    current.day === next.day &&
                    current.name === next.name &&
                    current.teacher === next.teacher &&
                    current.room === next.room &&
                    (current.start + current.step) === next.start // å¿…é¡»åœ¨æ—¶é—´ä¸Šè¿ç»­
                );

                if (isSame) {
                    current.step += next.step; // ç´¯åŠ è·¨åº¦
                } else {
                    mergedCourses.push(current);
                    current = { ...next };
                }
            }
            mergedCourses.push(current);
        }

        const ROW_HEIGHT = 58; 

        mergedCourses.forEach(c => {
            const day = c.day || 1;
            const start = c.start || 1;
            const step = c.step || 1; 
            
            const widthPercent = 100 / 7;
            const left = (day - 1) * widthPercent;
            const top = (start - 1) * ROW_HEIGHT;
            const height = step * ROW_HEIGHT;

            const card = document.createElement('div');
            card.className = 'course-card-abs';
            // ä½ç½®è®¡ç®—ï¼šleftåŠ 1pxï¼ŒtopåŠ 1pxï¼Œheightå‡2pxï¼Œç•™å‡ºé—´éš™
            card.style.left = `calc(${left}% + 1px)`;
            card.style.top = `${top + 1}px`;
            card.style.height = `${height - 2}px`;
            card.style.backgroundColor = getCourseColor(c.name);
            
            card.innerHTML = `
                <div class="course-name">${c.name}</div>
                <div class="course-info">ğŸ“${c.room}</div>
                <div class="course-info">ğŸ‘¨â€ğŸ«${c.teacher}</div>
            `;
            canvas.appendChild(card);
        });
    }
</script>
</body>
</html>