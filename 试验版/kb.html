<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBUT æ•™åŠ¡å°ç¨‹åºè°ƒè¯• (æŒ‰å‘¨æ˜¾ç¤º)</title>
    <style>
        :root { --primary: #007bff; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary); }
        .panel { display: none; padding: 20px; }
        .panel.active { display: block; }
        .form-group { margin-bottom: 15px; }
        input, button, select { width: 100%; padding: 10px; margin-top:5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: var(--primary); color: #fff; border: none; cursor: pointer; }
        button:disabled { background: #ccc; }
        
        /* è¯¾è¡¨æ ·å¼ */
        .timetable-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: #eef; padding: 10px; border-radius: 5px;}
        .timetable-grid { display: grid; grid-template-columns: 40px repeat(7, 1fr); gap: 2px; background: #eee; border: 1px solid #ddd; }
        .grid-header, .grid-cell { background: #fff; padding: 5px; text-align: center; font-size: 12px; min-height: 50px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .grid-header { font-weight: bold; background: #f8f9fa; }
        .course-item { 
            background: #d4edda; border-left: 3px solid #28a745; 
            padding: 4px; margin: 2px; border-radius: 3px; width: 90%; 
            font-size: 11px; text-align: left; overflow: hidden;
        }
        .week-selector { flex: 1; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ HBUT è¯¾è¡¨è°ƒè¯• (å‘¨æ¬¡ç­›é€‰ç‰ˆ)</h2>

    <!-- ç™»å½•é¢æ¿ -->
    <div id="panel-login" class="panel active">
        <h3>ç»Ÿä¸€èº«ä»½è®¤è¯</h3>
        <div class="form-group">
            <input type="text" id="u_name" placeholder="å­¦å·">
            <input type="password" id="u_pass" placeholder="å¯†ç ">
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="text" id="u_captcha" placeholder="éªŒè¯ç ">
                <img id="captcha-img" src="" onclick="loadCaptcha()" style="height:42px; border:1px solid #ddd; cursor:pointer;">
            </div>
        </div>
        <button onclick="doLogin()" id="btn-login">ç™»å½•</button>
        <p id="login-msg" style="color:red; margin-top:10px;"></p>
    </div>

    <!-- è¯¾è¡¨é¢æ¿ -->
    <div id="panel-timetable" class="panel">
        <div class="timetable-controls">
            <div>
                <label>å­¦æœŸ:</label>
                <input type="text" id="kb-xnxq" value="2025-2026-1" style="width:120px;">
            </div>
            <div class="week-selector">
                <label>é€‰æ‹©å‘¨æ¬¡:</label>
                <select id="week-select" onchange="renderCurrentWeek()">
                    <!-- JSåŠ¨æ€ç”Ÿæˆ 1-25 å‘¨ -->
                </select>
            </div>
            <button onclick="fetchTimetableData()" style="width:auto;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        
        <p id="status-text" style="color:blue; font-size:13px;"></p>

        <!-- è¯¾è¡¨ç½‘æ ¼ (7åˆ— + å·¦ä¾§è¡¨å¤´) -->
        <div class="timetable-grid" id="timetable-view">
            <!-- JSå¡«å…… -->
        </div>
    </div>
</div>

<script>
    const API = "http://127.0.0.1:8000/api";
    let tempToken = "";
    let userToken = "";
    let allCourses = []; // å­˜å‚¨åç«¯è¿”å›çš„æ‰€æœ‰è¯¾ç¨‹
    let currentWeekIndex = 1; // å½“å‰åˆ°åº•æ˜¯ç¬¬å‡ å‘¨

    window.onload = loadCaptcha;

    // 1. è·å–éªŒè¯ç 
    async function loadCaptcha() {
        try {
            const res = await fetch(`${API}/captcha`);
            const json = await res.json();
            document.getElementById('captcha-img').src = json.data.image;
            tempToken = json.data.token;
        } catch (e) { alert("æ— æ³•è¿æ¥åç«¯"); }
    }

    // 2. ç™»å½•
    async function doLogin() {
        const u = document.getElementById('u_name').value;
        const p = document.getElementById('u_pass').value;
        const c = document.getElementById('u_captcha').value;
        const btn = document.getElementById('btn-login');

        btn.disabled = true;
        btn.innerText = "ç™»å½•ä¸­...";
        
        try {
            const res = await fetch(`${API}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token: tempToken, username: u, password: p, captcha: c })
            });
            const json = await res.json();
            
            if(json.code === 200) {
                userToken = json.user_token;
                document.getElementById('panel-login').classList.remove('active');
                document.getElementById('panel-timetable').classList.add('active');
                initWeekSelect(); // åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
                fetchTimetableData(); // æ‹‰å–æ•°æ®
            } else {
                document.getElementById('login-msg').innerText = json.msg;
                loadCaptcha();
            }
        } catch (e) { alert("ç™»å½•è¯·æ±‚å‡ºé”™"); }
        finally { btn.disabled = false; btn.innerText = "ç™»å½•"; }
    }

    // åˆå§‹åŒ–å‘¨æ¬¡ä¸‹æ‹‰æ¡† (1-25å‘¨)
    function initWeekSelect() {
        const sel = document.getElementById('week-select');
        sel.innerHTML = "";
        for(let i=1; i<=25; i++) {
            sel.innerHTML += `<option value="${i}">ç¬¬ ${i} å‘¨</option>`;
        }
    }

    // 3. è·å–è¯¾è¡¨æ•°æ® (åç«¯ä¼šè¿”å›æ‰€æœ‰è¯¾ç¨‹ + å½“å‰å‘¨æ¬¡)
    async function fetchTimetableData() {
        const xnxq = document.getElementById('kb-xnxq').value;
        const status = document.getElementById('status-text');
        status.innerText = "æ­£åœ¨è·å–æœ€æ–°æ•°æ®...";

        try {
            const res = await fetch(`${API}/timetable`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token: userToken, xnxq: xnxq })
            });
            const json = await res.json();

            if(json.code === 200) {
                allCourses = json.data; // å­˜ä¸‹æ‰€æœ‰æ•°æ®
                currentWeekIndex = json.current_week || 1; // è·å–å½“å‰å‘¨
                
                // è®¾ç½®ä¸‹æ‹‰æ¡†ä¸ºå½“å‰å‘¨
                const sel = document.getElementById('week-select');
                sel.value = currentWeekIndex;
                
                status.innerText = `è·å–æˆåŠŸï¼æœ¬å‘¨æ˜¯ç¬¬ ${currentWeekIndex} å‘¨ã€‚`;
                renderCurrentWeek(); // æ¸²æŸ“
            } else {
                status.innerText = json.msg;
            }
        } catch(e) { status.innerText = "è·å–å¤±è´¥"; }
    }

    // 4. æ¸²æŸ“å½“å‰é€‰ä¸­å‘¨çš„è¯¾è¡¨
    function renderCurrentWeek() {
        const selectedWeek = parseInt(document.getElementById('week-select').value);
        const grid = document.getElementById('timetable-view');
        
        // 4.1 ç­›é€‰ï¼šåªä¿ç•™æœ¬å‘¨æœ‰è¯¾çš„
        // é€»è¾‘ï¼šè¯¾ç¨‹çš„ weeks_list æ•°ç»„é‡Œ åŒ…å« selectedWeek
        const weekCourses = allCourses.filter(course => {
            return course.weeks_list.includes(selectedWeek);
        });

        // 4.2 ç»˜åˆ¶è¡¨å¤´
        let html = `<div class="grid-header"></div>`;
        const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'];
        days.forEach(d => html += `<div class="grid-header">${d}</div>`);

        // 4.3 ç»˜åˆ¶è¡¨æ ¼ (1-12èŠ‚)
        // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç½‘æ ¼ç»˜åˆ¶é€»è¾‘ï¼Œå®é™…å°ç¨‹åºé‡Œæ¨èç”¨ absolute å®šä½
        for (let row = 1; row <= 12; row++) {
            // å·¦ä¾§èŠ‚æ¬¡
            html += `<div class="grid-header">${row}</div>`;
            
            // å‘¨ä¸€åˆ°å‘¨æ—¥
            for (let day = 1; day <= 7; day++) {
                // æŸ¥æ‰¾å½“å‰æ ¼å­æœ‰æ²¡æœ‰è¯¾
                // æ¡ä»¶ï¼šæ˜ŸæœŸå‡ åŒ¹é… && èŠ‚æ¬¡åŒ¹é… (row åœ¨ start å’Œ start+step ä¹‹é—´)
                const found = weekCourses.find(c => 
                    c.day === day && row >= c.start && row < (c.start + c.step)
                );

                if (found) {
                    // å¦‚æœæ˜¯è¯¾ç¨‹çš„ç¬¬ä¸€èŠ‚ï¼Œæ˜¾ç¤ºå†…å®¹
                    if (row === found.start) {
                        html += `
                        <div class="grid-cell" style="grid-row: span ${found.step}; background:#e3f2fd; border-bottom:1px solid #fff;">
                            <div class="course-item">
                                <strong>${found.name}</strong><br>
                                ğŸ“${found.room}<br>
                                ğŸ‘¨â€ğŸ«${found.teacher}
                            </div>
                        </div>`;
                    } else {
                        // å¦‚æœæ˜¯è¯¾ç¨‹çš„åç»­èŠ‚æ¬¡ï¼Œä¸æ¸²æŸ“ï¼ˆå› ä¸ºè¢«ç¬¬ä¸€èŠ‚çš„ span è¦†ç›–äº†ï¼Œæˆ–è€…å¿½ç•¥ï¼‰
                        // åœ¨ CSS Grid ä¸­ï¼Œå¦‚æœæ˜¯ span è¦†ç›–äº†ï¼Œè¿™é‡Œå…¶å®å¯ä»¥å¡«ç©º div æˆ–è€…æ ¹æœ¬ä¸å¡«
                        // ç®€å•èµ·è§ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸å¤„ç† spanï¼Œç›´æ¥æ¯èŠ‚éƒ½å¡«ï¼Œä½†åªç¬¬ä¸€èŠ‚æ˜¾ç¤ºå­—
                        // æ›´å¥½çš„åšæ³•å‚è€ƒä¸‹é¢ï¼š
                    }
                } else {
                    html += `<div class="grid-cell"></div>`;
                }
            }
        }
        
        // *æ³¨ï¼šä¸Šé¢çš„å¾ªç¯æ¸²æŸ“é€»è¾‘ä¸ºäº†ä»£ç ç®€å•ï¼Œå¯¹äºè·¨è¡Œ(span)æ”¯æŒä¸å¥½ã€‚
        // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬æ¢ä¸€ç§ç®€å•ç²—æš´çš„æ¸²æŸ“æ–¹å¼ï¼šç›´æ¥æ¸²æŸ“æ ¼å­ï¼Œä¸åˆå¹¶å•å…ƒæ ¼
        // å®é™…å°ç¨‹åºå»ºè®®ä½¿ç”¨ flex/absolute å¸ƒå±€
        
        let gridHtml = `<div class="grid-header"></div>`;
        days.forEach(d => gridHtml += `<div class="grid-header">${d}</div>`);
        
        for(let row=1; row<=12; row++){
             gridHtml += `<div class="grid-header">${row}</div>`;
             for(let day=1; day<=7; day++){
                 // æ‰¾è¯¾
                 const found = weekCourses.find(c => c.day === day && row >= c.start && row < (c.start + c.step));
                 if(found) {
                     // åªæœ‰å½“æ˜¯ç¬¬ä¸€èŠ‚çš„æ—¶å€™æ‰æ˜¾ç¤ºåå­—ï¼Œé˜²æ­¢é‡å¤æ˜¾ç¤º
                     if(row === found.start) {
                         gridHtml += `<div class="grid-cell" style="background:#e3f2fd; color:#333; align-items:flex-start; overflow:hidden;">
                            <span style="font-size:10px; font-weight:bold;">${found.name}</span>
                            <span style="font-size:9px;">@${found.room}</span>
                         </div>`;
                     } else {
                         gridHtml += `<div class="grid-cell" style="background:#e3f2fd;"></div>`;
                     }
                 } else {
                     gridHtml += `<div class="grid-cell"></div>`;
                 }
             }
        }

        grid.innerHTML = gridHtml;
    }
</script>

</body>
</html>