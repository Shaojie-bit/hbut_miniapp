<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBUT æˆç»©æŸ¥è¯¢è°ƒè¯• (å«ç­›é€‰)</title>
    <style>
        /* ä¿æŒä¹‹å‰çš„æ ·å¼ï¼Œå¢åŠ ç­›é€‰æ æ ·å¼ */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 10px; color: #007bff; }
        .step { margin-bottom: 30px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa; }
        .step.active { border-color: #007bff; background: #f0f7ff; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        button:hover { background-color: #0056b3; }
        .captcha-box { display: flex; gap: 10px; align-items: center; }
        #captcha-img { border: 1px solid #ddd; height: 50px; cursor: pointer; border-radius: 4px; }
        
        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .retake { color: red; font-weight: bold; }
        .score-pass { color: green; font-weight: bold; }
        .score-fail { color: red; font-weight: bold; }

        /* ç­›é€‰æ  */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; padding: 10px; background: #eee; border-radius: 4px; align-items: center; }
        .filter-bar select { width: auto; flex-grow: 1; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ HBUT æˆç»©æŸ¥è¯¢ (å…¨é‡ç‰ˆ)</h2>

    <div class="step active" id="step1">
        <h3>1. èº«ä»½è®¤è¯</h3>
        <div class="form-group captcha-box">
            <img id="captcha-img" src="" onclick="loadCaptcha()" title="ç‚¹å‡»åˆ·æ–°">
            <button onclick="loadCaptcha()">åˆ·æ–°éªŒè¯ç </button>
        </div>
        <div class="form-group">
            <input type="text" id="username" placeholder="å­¦å·" value="">
        </div>
        <div class="form-group">
            <input type="password" id="password" placeholder="å¯†ç ">
        </div>
        <div class="form-group">
            <input type="text" id="captcha-input" placeholder="è¾“å…¥éªŒè¯ç " maxlength="4">
        </div>
        <button id="btn-login" onclick="doLogin()">ç™»å½•å¹¶è·å–æˆç»©</button>
        <div id="msg-log" style="margin-top:10px; color: red;"></div>
    </div>

    <div class="step" id="step2" style="display:none;">
        <h3>2. æˆç»©å•</h3>
        
        <div class="filter-bar">
            <label>ğŸ“… é€‰æ‹©å­¦æœŸï¼š</label>
            <select id="semester-select" onchange="filterTable()">
                <option value="all">å…¨éƒ¨å­¦æœŸ</option>
            </select>
            <span id="stats-info" style="font-size: 0.9em; color: #666;"></span>
        </div>

        <div style="overflow-y: auto; max-height: 500px;">
            <table id="grade-table">
                <thead>
                    <tr>
                        <th>å­¦æœŸ</th>
                        <th>è¯¾ç¨‹åç§°</th>
                        <th>æ€§è´¨</th>
                        <th>å­¦åˆ†</th>
                        <th>æˆç»©</th>
                    </tr>
                </thead>
                <tbody id="grade-tbody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://127.0.0.1:8000";
    let currentCaptchaToken = "";
    let allGradesData = []; // å­˜å‚¨æ‰€æœ‰æˆç»©

    window.onload = loadCaptcha;

    async function loadCaptcha() {
        try {
            const res = await fetch(`${API_BASE}/api/captcha`);
            const json = await res.json();
            if (json.code === 200) {
                document.getElementById('captcha-img').src = json.data.image;
                currentCaptchaToken = json.data.token;
            }
        } catch (e) { alert("è¿æ¥åç«¯å¤±è´¥"); }
    }

    async function doLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const c = document.getElementById('captcha-input').value;
        const btn = document.getElementById('btn-login');
        const log = document.getElementById('msg-log');

        btn.disabled = true;
        btn.innerText = "ç™»å½•ä¸­...";
        log.innerText = "";

        try {
            // 1. ç™»å½•
            const loginRes = await fetch(`${API_BASE}/api/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: currentCaptchaToken, username: u, password: p, captcha: c })
            });
            const loginJson = await loginRes.json();

            if (loginJson.code !== 200) {
                throw new Error(loginJson.msg);
            }

            // 2. æ‹‰å–æˆç»©
            btn.innerText = "æ­£åœ¨æ‹‰å–æˆç»©...";
            const gradeRes = await fetch(`${API_BASE}/api/grades`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: loginJson.user_token })
            });
            const gradeJson = await gradeRes.json();

            if (gradeJson.code === 200) {
                // æˆåŠŸï¼
                allGradesData = gradeJson.data;
                initGradeView();
                document.getElementById('step2').style.display = 'block';
                document.getElementById('step1').style.display = 'none';
            } else {
                throw new Error("æˆç»©è·å–å¤±è´¥");
            }

        } catch (e) {
            log.innerText = e.message;
            loadCaptcha(); // å¤±è´¥è¦åˆ·æ–°éªŒè¯ç 
        } finally {
            btn.disabled = false;
            btn.innerText = "ç™»å½•å¹¶è·å–æˆç»©";
        }
    }

    // åˆå§‹åŒ–è§†å›¾ï¼šå¡«å……ä¸‹æ‹‰æ¡†
    function initGradeView() {
        const semesterSet = new Set();
        allGradesData.forEach(g => semesterSet.add(g.semester));
        
        // æ’åºï¼šæœ€æ–°çš„å­¦æœŸæ’å‰é¢
        const sortedSemesters = Array.from(semesterSet).sort().reverse();
        
        const select = document.getElementById('semester-select');
        select.innerHTML = '<option value="all">å…¨éƒ¨å­¦æœŸ</option>';
        sortedSemesters.forEach(sem => {
            select.innerHTML += `<option value="${sem}">${sem}</option>`;
        });

        // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨
        renderTable(allGradesData);
    }

    // ç­›é€‰é€»è¾‘
    function filterTable() {
        const selected = document.getElementById('semester-select').value;
        if (selected === 'all') {
            renderTable(allGradesData);
        } else {
            const filtered = allGradesData.filter(g => g.semester === selected);
            renderTable(filtered);
        }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(data) {
        const tbody = document.getElementById('grade-tbody');
        tbody.innerHTML = "";
        
        let totalCredit = 0;

        data.forEach(row => {
            // ç®€å•ç»Ÿè®¡å­¦åˆ† (åªç®—æ•°å­—)
            const credit = parseFloat(row.credit) || 0;
            totalCredit += credit;

            const isRetake = row.is_retake ? 'class="retake"' : '';
            const retakeText = row.is_retake ? '<span style="color:red">[é‡ä¿®]</span> ' : '';
            
            // æˆç»©é¢œè‰²
            let scoreClass = "";
            let scoreVal = parseFloat(row.score);
            if (!isNaN(scoreVal)) {
                scoreClass = scoreVal >= 60 ? "score-pass" : "score-fail";
            }

            tbody.innerHTML += `
                <tr ${isRetake}>
                    <td>${row.semester}</td>
                    <td>${retakeText}${row.course_name}</td>
                    <td>${row.type}</td>
                    <td>${row.credit}</td>
                    <td class="${scoreClass}">${row.score}</td>
                </tr>
            `;
        });

        document.getElementById('stats-info').innerText = `å…± ${data.length} é—¨è¯¾ï¼Œæ€»å­¦åˆ†: ${totalCredit.toFixed(1)}`;
    }
</script>

</body>
</html>