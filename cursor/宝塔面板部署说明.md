# 宝塔面板 Python 项目管理器部署说明

## 启动方式说明

### `uvicorn` 命令的含义

`uvicorn cjcx+pm:app --host 0.0.0.0 --port 8000` 这个命令的意思是：
- `uvicorn` - ASGI 服务器，用于运行 FastAPI 应用
- `cjcx+pm:app` - 模块名:应用实例（`cjcx+pm.py` 文件中的 `app` 对象）
- `--host 0.0.0.0` - 监听所有网络接口
- `--port 8000` - 监听 8000 端口

### 宝塔面板的三种启动方式

由于宝塔面板的 Python 项目管理器可能不支持直接使用 `uvicorn`，我们提供以下三种方案：

---

## 方案一：使用 Gunicorn（推荐）⭐

Gunicorn 是一个成熟的 WSGI/ASGI 服务器，宝塔面板支持，且性能更好。

### 步骤：

1. **安装依赖**
   - 在 Python 项目管理器中，找到项目 → **模块**
   - 安装：`gunicorn`（如果未安装）

2. **配置启动方式**
   - 启动方式选择：**gunicorn**
   - 启动文件/应用名：`cjcx+pm:app`
   - 绑定IP和端口：`0.0.0.0:8000`
   - 进程数：`2`（根据服务器配置调整，建议 CPU核心数 × 2 + 1）
   - Worker类型：`uvicorn.workers.UvicornWorker`（重要！）

3. **高级配置**（可选）
   - 如果支持配置文件，可以上传 `gunicorn_config.py`
   - 或者直接在启动参数中添加：
     ```
     --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
     ```

### Gunicorn 启动命令示例：
```bash
gunicorn cjcx+pm:app --workers 2 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

---

## 方案二：使用命令行启动

如果宝塔面板支持命令行启动，可以这样配置：

1. **启动方式选择**：**命令行启动**

2. **启动命令**：
   ```bash
   /www/server/python/py3.11/bin/uvicorn cjcx+pm:app --host 0.0.0.0 --port 8000 --workers 2
   ```
   
   **注意**：请根据实际的 Python 路径修改 `/www/server/python/py3.11/bin/uvicorn`

3. **查找 Python 路径的方法**：
   ```bash
   # SSH 连接服务器后执行
   which python3
   which uvicorn
   # 或者
   find /www/server/python -name uvicorn
   ```

---

## 方案三：使用 Systemd（最稳定）⭐

如果宝塔面板的 Python 项目管理器不方便，建议直接使用 systemd 服务（推荐）。

### 步骤：

1. **通过 SSH 连接服务器**

2. **创建服务文件**：
   ```bash
   sudo nano /etc/systemd/system/hbut-api.service
   ```

3. **粘贴以下内容**（根据实际 Python 路径修改）：
   ```ini
   [Unit]
   Description=HBUT 教务系统 API 服务
   After=network.target

   [Service]
   Type=simple
   User=www
   Group=www
   WorkingDirectory=/www/wwwroot/hbut.zmj888.asia
   Environment="PATH=/www/server/python/py3.11/bin:/usr/local/bin:/usr/bin:/bin"
   ExecStart=/www/server/python/py3.11/bin/uvicorn cjcx+pm:app --host 0.0.0.0 --port 8000 --workers 2
   Restart=always
   RestartSec=3
   StandardOutput=journal
   StandardError=journal

   [Install]
   WantedBy=multi-user.target
   ```

4. **启动服务**：
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable hbut-api
   sudo systemctl start hbut-api
   sudo systemctl status hbut-api
   ```

---

## 推荐配置（Gunicorn）

### 在宝塔面板 Python 项目管理器中：

**基本配置：**
- 项目名称：`hbut-api`
- 项目路径：`/www/wwwroot/hbut.zmj888.asia`
- Python 版本：选择已安装的版本（如 3.11）
- 框架：**其他**
- 启动方式：**gunicorn**
- 启动文件/应用名：`cjcx+pm:app`
- 绑定IP和端口：`0.0.0.0:8000`
- 进程数：`2`（或根据服务器 CPU 核心数调整）
- Worker类型：`uvicorn.workers.UvicornWorker` ⚠️ **必须填写这个**

**高级配置（如果有）：**
```
--workers 2 --worker-class uvicorn.workers.UvicornWorker --timeout 60 --bind 0.0.0.0:8000
```

---

## 验证部署

部署完成后，检查服务是否运行：

1. **在宝塔面板中**：
   - Python项目管理器 → 查看项目状态
   - 应该显示"运行中"

2. **通过 SSH**：
   ```bash
   # 检查端口是否监听
   netstat -tlnp | grep 8000
   # 或
   ss -tlnp | grep 8000
   
   # 测试 API
   curl http://localhost:8000/api/captcha
   ```

3. **在浏览器中**：
   - 访问 `http://hbut.zmj888.asia` 或 `http://你的服务器IP:8000`
   - 应该能看到登录页面

---

## 常见问题

### Q1: 找不到 `uvicorn.workers.UvicornWorker`

**解决方法**：
确保已安装 `uvicorn` 和 `gunicorn`：
```bash
/www/server/python/py3.11/bin/pip3 install uvicorn[standard] gunicorn
```

### Q2: Worker 类型填写什么？

- 如果使用 Gunicorn：填写 `uvicorn.workers.UvicornWorker`
- 如果使用 uWSGI：填写 `asgi`（但 uWSGI 对 ASGI 支持不好，不推荐）

### Q3: 如何查看日志？

- **宝塔面板**：Python项目管理器 → 项目 → 日志
- **SSH**：
  ```bash
  # 如果使用 systemd
  sudo journalctl -u hbut-api -f
  
  # 如果使用宝塔面板
  tail -f /www/wwwroot/hbut.zmj888.asia/hbut_api.log
  ```

### Q4: 进程数设置多少合适？

- 公式：`CPU核心数 × 2 + 1`
- 例如：2核CPU → 5个进程，4核CPU → 9个进程
- 建议：小型服务器（1-2核）设置为 `2-4`，中型服务器（4核）设置为 `4-8`

---

## 总结

**推荐顺序**：
1. ✅ **方案三（Systemd）** - 最稳定，推荐生产环境
2. ✅ **方案一（Gunicorn）** - 如果必须使用宝塔面板
3. ⚠️ **方案二（命令行）** - 如果前两种都不行

选择最适合你环境的方案即可！

