# HBUT 教务系统部署指南

## 一、准备工作

### 1.1 服务器要求
- 操作系统：OpenCloudOS（已安装宝塔面板）
- Python 版本：3.8+（推荐 3.11）
- 域名：hbut.zmj888.asia（已解析到服务器 IP）

### 1.2 需要上传的文件
- `cjcx+pm.py` - 主程序文件
- `debug+pm.html` - 前端页面
- `requirements.txt` - Python 依赖

## 二、宝塔面板配置步骤

### 2.1 创建网站

1. 登录宝塔面板
2. 点击左侧菜单 **网站** → **添加站点**
3. 填写信息：
   - 域名：`hbut.zmj888.asia`
   - 根目录：`/www/wwwroot/hbut.zmj888.asia`
   - PHP 版本：**纯静态**（不需要 PHP）
4. 点击 **提交**

### 2.2 上传文件

1. 在宝塔面板中，点击 **文件** 菜单
2. 进入 `/www/wwwroot/hbut.zmj888.asia` 目录
3. 上传以下文件：
   - `cjcx+pm.py`
   - `debug+pm.html`
   - `requirements.txt`

### 2.3 安装 Python 环境

1. 在宝塔面板，点击 **软件商店**
2. 搜索并安装 **Python项目管理器**（如果未安装）
3. 或者使用系统自带的 Python（通过 SSH）

### 2.4 安装 Python 依赖

**方法一：通过宝塔面板 Python 项目管理器**

> ⚠️ **重要**：宝塔面板的 Python 项目管理器可能不支持直接使用 `uvicorn` 命令。
> 请参考 `宝塔面板部署说明.md` 文件，选择适合的启动方式（推荐使用 Gunicorn 或 Systemd）。

**使用 Gunicorn（推荐）：**

1. 打开 **Python项目管理器**
2. 点击 **添加项目**
3. 填写信息：
   - 项目名称：`hbut-api`
   - 项目路径：`/www/wwwroot/hbut.zmj888.asia`
   - Python 版本：选择 3.11（或已安装的版本）
   - 框架：选择 **其他**
   - **启动方式：选择 `gunicorn`**
   - **启动文件/应用名：`cjcx+pm:app`**
   - 绑定IP和端口：`0.0.0.0:8008`
   - **进程数：`2`**（根据服务器配置调整）
   - **Worker类型：`uvicorn.workers.UvicornWorker`** ⚠️ **必须填写**
4. 在项目列表中，找到刚创建的项目，点击 **模块**
5. 安装以下模块（逐个安装）：
   - `fastapi`
   - `uvicorn[standard]`
   - `gunicorn` ⭐ **新增**
   - `requests`
   - `beautifulsoup4`
   - `pycryptodome`
   - `pydantic`

**详细说明请查看：`宝塔面板部署说明.md`**

**方法二：通过 SSH 命令行（推荐）**

1. 通过 SSH 连接到服务器
2. 执行以下命令：

```bash
# 进入项目目录
cd /www/wwwroot/hbut.zmj888.asia

pip3 install -r requirements.txt

```

## 三、配置进程守护（Systemd）

### 3.1 创建 systemd 服务文件

1. 通过 SSH 连接到服务器
2. 创建服务文件：

```bash
sudo nano /etc/systemd/system/hbut-api.service
```

3. 复制以下内容（注意修改 Python 路径和项目路径）：

```ini
[Unit]
Description=HBUT 教务系统 API 服务
After=network.target

[Service]
Type=simple
User=www
Group=www
WorkingDirectory=/www/wwwroot/hbut.zmj888.asia
Environment="PATH=/usr/local/bin:/usr/bin:/bin"
ExecStart=/usr/local/bin/uvicorn cjcx+pm:app --host 0.0.0.0 --port 8008 --workers 2
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**重要：** 请根据实际 Python 路径修改：

- 如果 Python 在 `/usr/bin/python3`，则修改为 `/usr/bin/python3`
- 如果使用虚拟环境，修改 `ExecStart` 和 `Environment` 中的路径

4. 保存文件（Ctrl+O，回车，Ctrl+X）

### 3.2 启动服务

```bash
# 重新加载 systemd 配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start hbut-api

# 设置开机自启
sudo systemctl enable hbut-api

# 查看服务状态
sudo systemctl status hbut-api

# 查看日志
sudo journalctl -u hbut-api -f
```

### 3.3 常用管理命令

```bash
# 停止服务
sudo systemctl stop hbut-api

# 重启服务
sudo systemctl restart hbut-api

# 查看服务状态
sudo systemctl status hbut-api

# 查看实时日志
sudo journalctl -u hbut-api -f

# 查看最近 100 行日志
sudo journalctl -u hbut-api -n 100
```

## 四、配置 Nginx 反向代理

### 4.1 在宝塔面板配置

1. 在宝塔面板，点击 **网站** → 找到 `hbut.zmj888.asia` → 点击 **设置**
2. 点击 **配置文件** 标签
3. 将配置替换为以下内容（或参考 `nginx-hbut.conf` 文件）：

```nginx
server {
    listen 80;
    server_name hbut.zmj888.asia;
    
    location / {
        proxy_pass http://127.0.0.1:8008;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

4. 点击 **保存**

### 4.2 配置 SSL 证书（HTTPS）

1. 在宝塔面板，点击 **网站** → `hbut.zmj888.asia` → **设置** → **SSL**
2. 选择 **Let's Encrypt** 免费证书
3. 填写邮箱，勾选 **强制 HTTPS**
4. 点击 **申请**
5. 申请成功后，Nginx 配置会自动更新为 HTTPS

## 五、测试部署

### 5.1 检查服务运行状态

```bash
# 检查服务是否运行
sudo systemctl status hbut-api

# 检查端口是否监听
netstat -tlnp | grep 8008
# 或
ss -tlnp | grep 8008
```

### 5.2 测试 API

在浏览器中访问：
- `http://hbut.zmj888.asia/` - 应该显示前端页面
- `http://hbut.zmj888.asia/api/captcha` - 应该返回验证码 JSON

### 5.3 查看日志

```bash
# 查看应用日志
tail -f /www/wwwroot/hbut.zmj888.asia/hbut_api.log

# 查看 systemd 日志
sudo journalctl -u hbut-api -f
```

## 六、常见问题排查

### 6.1 服务无法启动

1. 检查 Python 路径是否正确：
```bash
which python3
# 或
ls -la /www/server/python/
```

2. 检查依赖是否安装：
```bash
/www/server/python/py3.11/bin/pip3 list | grep fastapi
```

3. 手动测试运行：
```bash
cd /www/wwwroot/hbut.zmj888.asia
/www/server/python/py3.11/bin/uvicorn cjcx+pm:app --host 0.0.0.0 --port 8008
```

### 6.2 502 Bad Gateway

1. 检查后端服务是否运行：
```bash
sudo systemctl status hbut-api
```

2. 检查端口是否被占用：
```bash
netstat -tlnp | grep 8008
```

3. 检查防火墙是否开放 8008 端口（通常不需要，因为使用本地代理）

### 6.3 无法访问域名

1. 检查域名解析：
```bash
ping hbut.zmj888.asia
nslookup hbut.zmj888.asia
```

2. 检查 Nginx 配置：
```bash
sudo nginx -t
```

3. 重启 Nginx：
```bash
sudo systemctl restart nginx
# 或在宝塔面板：网站 → 设置 → 重启
```

### 6.4 文件权限问题

```bash
# 确保文件权限正确
sudo chown -R www:www /www/wwwroot/hbut.zmj888.asia
sudo chmod -R 755 /www/wwwroot/hbut.zmj888.asia
```

## 七、维护建议

1. **定期查看日志**：检查 `hbut_api.log` 和 systemd 日志
2. **监控服务状态**：定期检查服务是否正常运行
3. **备份数据**：虽然使用内存存储，但建议定期备份代码
4. **更新依赖**：定期更新 Python 包以修复安全漏洞

## 八、安全建议

1. **使用 HTTPS**：配置 SSL 证书，启用 HTTPS
2. **防火墙设置**：确保只开放必要端口（80, 443）
3. **定期更新**：保持系统和 Python 包更新
4. **限制访问**：如果需要，可以在 Nginx 中配置 IP 白名单

## 九、快速命令参考

```bash
# 启动服务
sudo systemctl start hbut-api

# 停止服务
sudo systemctl stop hbut-api

# 重启服务
sudo systemctl restart hbut-api

# 查看状态
sudo systemctl status hbut-api

# 查看日志
sudo journalctl -u hbut-api -f

# 重新加载配置
sudo systemctl daemon-reload
sudo systemctl restart hbut-api
```

---

**部署完成后，访问 `http://hbut.zmj888.asia` 或 `https://hbut.zmj888.asia` 即可使用！**

